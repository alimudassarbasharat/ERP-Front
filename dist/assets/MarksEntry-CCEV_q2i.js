import{H as ee,l as d,p as ae,y as x,N as le,a as _,o as i,d as t,i as j,b as L,h as r,u as E,aK as T,ao as A,D as p,F as y,z as $,f as D,$ as P,t as w,A as te,a3 as se,ay as oe,R as V}from"./index-xvPUEXLW.js";const ne={class:"relative w-full min-h-screen pl-0 pr-0 sm:pl-0 sm:pr-0 lg:pl-1 lg:pr-0 py-2 sm:py-3 lg:py-4"},re={class:"relative z-10 w-full mt-2 mb-4 flex items-center justify-between bg-white/90 rounded-lg shadow-lg py-2 px-5 transition-all duration-500 border border-gray-200"},ie={class:"flex items-center gap-2 text-base font-medium text-gray-600"},de={class:"relative z-10 w-full"},ue={class:"w-full mb-4"},ce={class:"bg-white/90 rounded-xl p-6 shadow-lg border border-gray-200"},me={class:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"},ve=["disabled"],be={key:0,class:"w-full mb-4"},_e={class:"bg-white/90 rounded-xl p-6 shadow-lg border border-gray-200"},fe={class:"mb-6"},pe={class:"overflow-x-auto"},ge={class:"font-semibold text-gray-900"},ke={class:"text-xs text-gray-500"},he={class:"mt-6 flex justify-end gap-3"},xe=["disabled"],ye=["disabled"],we={key:1,class:"w-full mb-4"},Ve={class:"bg-white/90 rounded-xl p-6 shadow-lg border border-gray-200"},Ee={__name:"MarksEntry",setup(Se){const m=ee(),H=d(!1),S=d(!1),M=d(!1),U=d(!1),f=d(null),v=d([]),b=d([]),k=d([]),N=d([]),B=d([]),K=d([]),z=d([]),C=d([]),c=d([]),R=()=>{v.value=[],b.value=[],k.value=[],c.value=[],z.value=[]},q=async()=>{b.value=[],c.value=[],v.value.length>0&&await Q()},G=()=>{C.value=z.value.filter(a=>b.value.includes(a.id)),c.value.forEach(a=>{C.value.forEach(l=>{a.marks[l.id]||(a.marks[l.id]={total_marks:null,obtained_marks:null})})})},I=async()=>{try{const a=await V.get("/exams");(a.data.success||a.data.status)&&(N.value=a.data.result||a.data.data||[])}catch(a){console.error("Failed to load exams:",a)}},J=async()=>{try{const a=await V.get("/classes");(a.data.success||a.data.status)&&(B.value=a.data.result||a.data.data||[])}catch(a){console.error("Failed to load classes:",a)}},Q=async()=>{try{const a=await V.post("/exam-marks/fetch-subjects",{exam_id:f.value,class_ids:v.value});a.data.success&&(z.value=a.data.data||[])}catch(a){m.error("Failed to load subjects"),console.error(a)}},W=async()=>{if(!f.value||v.value.length===0||b.value.length===0){m.warning("Please select exam, classes, and subjects");return}S.value=!0;try{const a=await V.post("/exam-marks/fetch-students",{exam_id:f.value,class_ids:v.value,section_ids:k.value.length>0?k.value:null,subject_ids:b.value});if(a.data.success){const l=a.data.data||[];c.value=l.map(u=>({...u,marks:Object.fromEntries(C.value.map(s=>[s.id,{total_marks:s.total_marks||null,obtained_marks:null}])),is_absent:!1}))}}catch(a){m.error("Failed to load students"),console.error(a)}finally{S.value=!1}},X=async()=>{var a,l;M.value=!0;try{const u=c.value.map(n=>({student_id:n.student_id,class_id:n.class_id,section_id:n.section_id,marks:Object.entries(n.marks).map(([o,h])=>({subject_id:o,total_marks:h.total_marks,obtained_marks:h.obtained_marks,is_absent:n.is_absent}))}));(await V.post("/exam-marks/save-draft",{exam_id:f.value,marks_data:u})).data.success&&m.success("Draft saved successfully")}catch(u){m.error(((l=(a=u.response)==null?void 0:a.data)==null?void 0:l.message)||"Failed to save draft")}finally{M.value=!1}},Y=async()=>{var l,u;let a=!1;if(c.value.forEach(s=>{C.value.forEach(n=>{const o=s.marks[n.id];s.is_absent||((!o.total_marks||o.total_marks<=0)&&(a=!0,m.warning(`Please enter total marks for ${s.student_name} - ${n.name}`)),(o.obtained_marks===null||o.obtained_marks<0)&&(a=!0,m.warning(`Please enter obtained marks for ${s.student_name} - ${n.name}`)),o.obtained_marks>o.total_marks&&(a=!0,m.warning(`Obtained marks cannot exceed total marks for ${s.student_name} - ${n.name}`)))})}),!a){U.value=!0;try{const s=c.value.map(o=>({student_id:o.student_id,class_id:o.class_id,section_id:o.section_id,marks:Object.entries(o.marks).map(([h,F])=>({subject_id:h,total_marks:F.total_marks,obtained_marks:o.is_absent?0:F.obtained_marks,is_absent:o.is_absent}))}));(await V.post("/exam-marks/submit",{exam_id:f.value,class_ids:v.value,subject_ids:b.value,section_ids:k.value.length>0?k.value:null,marks_data:s})).data.success&&(m.success("Marks submitted for verification"),c.value=[])}catch(s){m.error(((u=(l=s.response)==null?void 0:l.data)==null?void 0:u.message)||"Failed to submit marks")}finally{U.value=!1}}};return ae(()=>{I(),J()}),(a,l)=>{const u=x("el-option"),s=x("el-select"),n=x("el-table-column"),o=x("el-input-number"),h=x("el-checkbox"),F=x("el-table"),Z=le("loading");return i(),_("div",ne,[t("div",re,[l[7]||(l[7]=t("h2",{class:"text-base font-medium text-gray-900 tracking-tight flex items-center gap-2"},[t("div",{class:"w-2 h-2 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full animate-pulse"}),j(" Enter Exam Marks ")],-1)),t("nav",ie,[t("span",{class:"hover:text-purple-600 cursor-pointer transition-colors duration-200",onClick:l[0]||(l[0]=e=>a.$router.push("/exams/center"))},"Exam Management"),l[5]||(l[5]=t("span",{class:"mx-2"},"|",-1)),l[6]||(l[6]=t("span",{class:"text-gray-900 font-bold"},"Enter Marks",-1))])]),t("div",de,[t("div",ue,[t("div",ce,[r(A,{title:"Select Details",icon:E(T)},null,8,["icon"]),t("div",me,[t("div",null,[l[8]||(l[8]=t("label",{class:"block text-sm font-semibold text-gray-900 mb-2"},"Exam",-1)),r(s,{modelValue:f.value,"onUpdate:modelValue":l[1]||(l[1]=e=>f.value=e),placeholder:"Select exam",filterable:"",size:"large",class:"w-full",onChange:R},{default:p(()=>[(i(!0),_(y,null,$(N.value,e=>(i(),D(u,{key:e.id,label:e.name||e.term,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),t("div",null,[l[9]||(l[9]=t("label",{class:"block text-sm font-semibold text-gray-900 dark:text-white mb-2"},"Classes (Multi-select)",-1)),r(s,{modelValue:v.value,"onUpdate:modelValue":l[2]||(l[2]=e=>v.value=e),placeholder:"Select classes",multiple:"",filterable:"",size:"large",class:"w-full",onChange:q},{default:p(()=>[(i(!0),_(y,null,$(B.value,e=>(i(),D(u,{key:e.id,label:e.name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),t("div",null,[l[10]||(l[10]=t("label",{class:"block text-sm font-semibold text-gray-900 dark:text-white mb-2"},"Subjects (Multi-select)",-1)),r(s,{modelValue:b.value,"onUpdate:modelValue":l[3]||(l[3]=e=>b.value=e),placeholder:"Select subjects",multiple:"",filterable:"",size:"large",class:"w-full",onChange:G},{default:p(()=>[(i(!0),_(y,null,$(z.value,e=>(i(),D(u,{key:e.id,label:e.name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),t("div",null,[l[11]||(l[11]=t("label",{class:"block text-sm font-semibold text-gray-900 dark:text-white mb-2"},"Sections (Optional)",-1)),r(s,{modelValue:k.value,"onUpdate:modelValue":l[4]||(l[4]=e=>k.value=e),placeholder:"Select sections (leave blank for all)",multiple:"",filterable:"",size:"large",class:"w-full",clearable:""},{default:p(()=>[(i(!0),_(y,null,$(K.value,e=>(i(),D(u,{key:e.id,label:e.name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])])]),f.value&&v.value.length>0&&b.value.length>0?(i(),_("button",{key:0,onClick:W,disabled:S.value,class:"h-10 px-6 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 text-sm font-bold text-white shadow hover:from-purple-600 hover:to-pink-600 transition-all duration-300 disabled:opacity-50 flex items-center gap-2"},[r(E(P),{class:"w-4 h-4"}),j(" "+w(S.value?"Loading...":"Load Students"),1)],8,ve)):L("",!0)])]),c.value.length>0?(i(),_("div",be,[t("div",_e,[t("div",fe,[r(A,{title:`Enter Marks for ${c.value.length} Student${c.value.length>1?"s":""}`,icon:E(T)},null,8,["title","icon"]),l[12]||(l[12]=t("p",{class:"text-sm text-gray-600 mt-2"}," Enter marks for each student and subject ",-1))]),t("div",pe,[te((i(),D(F,{data:c.value,stripe:"",border:"",style:{width:"100%"}},{default:p(()=>[r(n,{label:"Student","min-width":"200",fixed:""},{default:p(({row:e})=>[t("div",null,[t("p",ge,w(e.student_name),1),t("p",ke,w(e.class_name)+" - "+w(e.section_name||"All"),1)])]),_:1}),(i(!0),_(y,null,$(C.value,e=>(i(),_(y,{key:e.id},[r(n,{label:`${e.name} (Total)`,"min-width":"120"},{default:p(({row:g})=>[r(o,{modelValue:g.marks[e.id].total_marks,"onUpdate:modelValue":O=>g.marks[e.id].total_marks=O,min:0,size:"small",class:"w-full",placeholder:"Total"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["label"]),r(n,{label:`${e.name} (Obtained)`,"min-width":"120"},{default:p(({row:g})=>[r(o,{modelValue:g.marks[e.id].obtained_marks,"onUpdate:modelValue":O=>g.marks[e.id].obtained_marks=O,min:0,max:g.marks[e.id].total_marks||null,size:"small",class:"w-full",placeholder:"Obtained"},null,8,["modelValue","onUpdate:modelValue","max"])]),_:2},1032,["label"])],64))),128)),r(n,{label:"Absent",width:"100"},{default:p(({row:e})=>[r(h,{modelValue:e.is_absent,"onUpdate:modelValue":g=>e.is_absent=g},null,8,["modelValue","onUpdate:modelValue"])]),_:1})]),_:1},8,["data"])),[[Z,H.value]])]),t("div",he,[t("button",{onClick:X,disabled:M.value,class:"h-10 px-6 rounded-full bg-gradient-to-r from-gray-500 to-slate-500 text-sm font-bold text-white shadow hover:from-gray-600 hover:to-slate-600 transition-all duration-300 disabled:opacity-50"},w(M.value?"Saving...":"Save Draft"),9,xe),t("button",{onClick:Y,disabled:U.value,class:"h-10 px-6 rounded-full bg-gradient-to-r from-green-500 to-emerald-500 text-sm font-bold text-white shadow hover:from-green-600 hover:to-emerald-600 transition-all duration-300 disabled:opacity-50 flex items-center gap-2"},[r(E(se),{class:"w-4 h-4"}),j(" "+w(U.value?"Submitting...":"Submit for Verification"),1)],8,ye)])])])):f.value&&v.value.length>0&&b.value.length>0&&!S.value?(i(),_("div",we,[t("div",Ve,[r(oe,{title:"No students found",description:"Click 'Load Students' to load students for marks entry",icon:E(P),"icon-color":"blue"},null,8,["icon"])])])):L("",!0)])])}}};export{Ee as default};
