import{H as ve,l as i,c as fe,w as pe,p as be,y as p,f as b,o as d,D as s,d as r,a as m,b as k,h as l,ao as G,u as x,ap as J,F as E,z as $,t as _,i as c,aw as P,U as ye,a3 as K,au as O,aM as ge,ay as Q,as as we,R as y}from"./index-xvPUEXLW.js";import{_ as W}from"./StatusChip--xfdpyNX.js";const he={class:"w-full mb-4"},ke={class:"bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg border border-gray-200 dark:border-gray-700"},xe={key:0,class:"w-full mb-4"},Ve={class:"bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg border border-gray-200 dark:border-gray-700"},Ce={class:"flex items-center justify-between mb-4"},De={class:"text-xl font-bold text-gray-900 dark:text-white"},Ee={class:"text-gray-600 dark:text-gray-400 mt-1"},$e={class:"flex gap-2"},Se={key:0,class:"mb-4 p-4 bg-red-50 dark:bg-red-900/20 rounded-lg border border-red-200 dark:border-red-800"},Fe={class:"flex items-center gap-2"},je={class:"font-semibold text-red-600 dark:text-red-400"},Ue={key:1,class:"w-full mb-4"},Ae={class:"bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg border border-gray-200 dark:border-gray-700"},Me={key:1,class:"text-gray-400"},Ne={class:"flex gap-2"},He={key:2,class:"w-full mb-4"},Ye={class:"bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg border border-gray-200 dark:border-gray-700"},Pe={key:0,class:"space-y-4"},qe={class:"font-semibold text-red-600 dark:text-red-400 mb-2"},Be={class:"text-sm text-gray-700 dark:text-gray-300"},Te={key:0,class:"mt-2 text-blue-600 dark:text-blue-400"},Ie={__name:"DatesheetManagement",setup(ze){const v=ve(),N=i(!1),S=i(!1),H=i(!1),g=i(null),n=i(null),q=i([]),B=i([]),Y=i([]),T=i([]),z=i([]),U=i([]),C=i(!1),F=i(!1),A=i(null),o=i({class_id:null,section_id:null,subject_id:null,exam_date:null,start_time:null,end_time:null,room_name:"",paper_id:null}),D=fe(()=>U.value.length),X=a=>new Date(a).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}),Z=async()=>{try{const a=await y.get("/exams");(a.data.success||a.data.status)&&(q.value=a.data.result||a.data.data||[])}catch(a){console.error("Failed to load exams:",a)}},M=async()=>{var a;if(!g.value){n.value=null;return}N.value=!0;try{const t=await y.get(`/datesheets/exams/${g.value}`);t.data.success?(n.value=t.data.data,await ee(),await le()):n.value=null}catch(t){((a=t.response)==null?void 0:a.status)===404?n.value=null:v.error("Failed to load datesheet")}finally{N.value=!1}},ee=async()=>{if(n.value)try{const a=await y.get(`/datesheets/${n.value.id}/conflicts`);a.data.success&&(U.value=a.data.data.conflicts||[])}catch(a){console.error("Failed to load conflicts:",a)}},ae=async()=>{try{const a=await y.get("/classes");(a.data.success||a.data.status)&&(B.value=a.data.result||a.data.data||[])}catch(a){console.error("Failed to load classes:",a)}},R=async()=>{if(!o.value.class_id){Y.value=[];return}try{const a=await y.get("/sections",{params:{class_id:o.value.class_id}});(a.data.success||a.data.status)&&(Y.value=a.data.result||a.data.data||[])}catch(a){console.error("Failed to load sections:",a)}},te=async()=>{try{const a=await y.get("/subjects");(a.data.success||a.data.status)&&(T.value=a.data.result||a.data.data||[])}catch(a){console.error("Failed to load subjects:",a)}},le=async()=>{if(g.value)try{const a=await y.get("/exam-papers",{params:{exam_id:g.value,status:"approved"}});a.data.success&&(z.value=a.data.data.data||a.data.data||[])}catch(a){console.error("Failed to load papers:",a)}},se=async()=>{var a,t;S.value=!0;try{const u=await y.post("/datesheets",{exam_id:g.value});u.data.success&&(n.value=u.data.data,v.success("Datesheet created"))}catch(u){v.error(((t=(a=u.response)==null?void 0:a.data)==null?void 0:t.message)||"Failed to create datesheet")}finally{S.value=!1}},oe=async()=>{var a,t;if(!o.value.class_id||!o.value.subject_id||!o.value.exam_date||!o.value.start_time||!o.value.end_time){v.warning("Please fill all required fields");return}S.value=!0;try{A.value?(await y.put(`/datesheets/entries/${A.value.id}`,o.value),v.success("Entry updated")):(await y.post(`/datesheets/${n.value.id}/entries`,o.value),v.success("Entry added")),C.value=!1,A.value=null,o.value={class_id:null,section_id:null,subject_id:null,exam_date:null,start_time:null,end_time:null,room_name:"",paper_id:null},await M()}catch(u){v.error(((t=(a=u.response)==null?void 0:a.data)==null?void 0:t.message)||"Failed to save entry")}finally{S.value=!1}},de=a=>{A.value=a,o.value={class_id:a.class_id,section_id:a.section_id,subject_id:a.subject_id,exam_date:a.exam_date,start_time:a.start_time,end_time:a.end_time,room_name:a.room_name||"",paper_id:a.paper_id},R(),C.value=!0},ne=async a=>{var t,u;try{await y.delete(`/datesheets/entries/${a.id}`),v.success("Entry deleted"),await M()}catch(V){v.error(((u=(t=V.response)==null?void 0:t.data)==null?void 0:u.message)||"Failed to delete entry")}},re=async()=>{var a,t;if(D.value>0){v.warning("Cannot publish: Please resolve all conflicts first"),F.value=!0;return}H.value=!0;try{(await y.post(`/datesheets/${n.value.id}/publish`)).data.success&&(v.success("Datesheet published successfully"),await M())}catch(u){v.error(((t=(a=u.response)==null?void 0:a.data)==null?void 0:t.message)||"Failed to publish datesheet")}finally{H.value=!1}};return pe(()=>o.value.class_id,()=>{R()}),be(()=>{Z(),ae(),te()}),(a,t)=>{const u=p("el-option"),V=p("el-select"),ue=p("el-icon"),w=p("el-table-column"),j=p("el-button"),ie=p("el-table"),h=p("el-form-item"),ce=p("el-date-picker"),L=p("el-time-picker"),me=p("el-input"),_e=p("el-form"),I=p("el-dialog");return d(),b(we,{title:"Datesheet Management",breadcrumbs:[{label:"Exam Management",route:"/exams/center"},{label:"Datesheet"}]},{default:s(()=>[r("div",he,[r("div",ke,[l(G,{title:"Select Exam",icon:x(J)},null,8,["icon"]),l(V,{modelValue:g.value,"onUpdate:modelValue":t[0]||(t[0]=e=>g.value=e),placeholder:"Choose an exam...",filterable:"",size:"large",class:"w-full",onChange:M},{default:s(()=>[(d(!0),m(E,null,$(q.value,e=>(d(),b(u,{key:e.id,label:e.name||e.term,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])])]),n.value?(d(),m("div",xe,[r("div",Ve,[r("div",Ce,[r("div",null,[r("h2",De,_(n.value.title||"Datesheet"),1),r("p",Ee,[t[15]||(t[15]=c(" Status: ",-1)),l(W,{label:n.value.status,status:n.value.status==="published"?"success":"warning"},null,8,["label","status"])])]),r("div",$e,[n.value.status==="draft"?(d(),b(P,{key:0,label:"Add Entry",icon:x(ye),variant:"primary",onClick:t[1]||(t[1]=e=>C.value=!0)},null,8,["icon"])):k("",!0),n.value.status==="draft"&&D.value===0?(d(),b(P,{key:1,label:"Publish Datesheet",icon:x(K),variant:"success",loading:H.value,onClick:re},null,8,["icon","loading"])):k("",!0),n.value.status==="draft"&&D.value>0?(d(),b(P,{key:2,label:"View Conflicts",icon:x(O),variant:"warning",onClick:t[2]||(t[2]=e=>F.value=!0)},null,8,["icon"])):k("",!0)])]),D.value>0?(d(),m("div",Se,[r("div",Fe,[l(ue,{class:"text-red-600 dark:text-red-400"},{default:s(()=>[l(x(O))]),_:1}),r("p",je,_(D.value)+" conflict"+_(D.value>1?"s":"")+" detected. Cannot publish until resolved. ",1)])])):k("",!0)])])):k("",!0),n.value&&n.value.entries?(d(),m("div",Ue,[r("div",Ae,[l(G,{title:"Exam Schedule",icon:x(ge)},null,8,["icon"]),l(ie,{data:n.value.entries,stripe:"",style:{width:"100%"}},{default:s(()=>[l(w,{label:"Date",width:"120"},{default:s(({row:e})=>[c(_(X(e.exam_date)),1)]),_:1}),l(w,{label:"Time",width:"150"},{default:s(({row:e})=>[c(_(e.start_time)+" - "+_(e.end_time),1)]),_:1}),l(w,{label:"Class","min-width":"120"},{default:s(({row:e})=>{var f;return[c(_(((f=e.class)==null?void 0:f.name)||"N/A"),1)]}),_:1}),l(w,{label:"Section",width:"100"},{default:s(({row:e})=>{var f;return[c(_(((f=e.section)==null?void 0:f.name)||"All"),1)]}),_:1}),l(w,{label:"Subject","min-width":"120"},{default:s(({row:e})=>{var f;return[c(_(((f=e.subject)==null?void 0:f.name)||"N/A"),1)]}),_:1}),l(w,{label:"Room",width:"120"},{default:s(({row:e})=>[c(_(e.room_name||e.room_id||"N/A"),1)]),_:1}),l(w,{label:"Paper Status",width:"130"},{default:s(({row:e})=>[e.paper?(d(),b(W,{key:0,label:e.paper.status,status:e.paper.status==="approved"?"success":"warning"},null,8,["label","status"])):(d(),m("span",Me,"No paper"))]),_:1}),n.value.status==="draft"?(d(),b(w,{key:0,label:"Actions",width:"150"},{default:s(({row:e})=>[r("div",Ne,[l(j,{text:"",type:"primary",size:"small",onClick:f=>de(e)},{default:s(()=>[...t[16]||(t[16]=[c("Edit",-1)])]),_:1},8,["onClick"]),l(j,{text:"",type:"danger",size:"small",onClick:f=>ne(e)},{default:s(()=>[...t[17]||(t[17]=[c("Delete",-1)])]),_:1},8,["onClick"])])]),_:1})):k("",!0)]),_:1},8,["data"])])])):g.value&&!N.value?(d(),m("div",He,[r("div",Ye,[l(Q,{title:"No datesheet found",description:"Create a datesheet for this exam",icon:x(J),"icon-color":"blue","action-label":"Create Datesheet",onAction:se},null,8,["icon"])])])):k("",!0),l(I,{modelValue:C.value,"onUpdate:modelValue":t[12]||(t[12]=e=>C.value=e),title:"Add Datesheet Entry",width:"700px"},{footer:s(()=>[l(j,{onClick:t[11]||(t[11]=e=>C.value=!1)},{default:s(()=>[...t[18]||(t[18]=[c("Cancel",-1)])]),_:1}),l(j,{type:"primary",onClick:oe,loading:S.value},{default:s(()=>[...t[19]||(t[19]=[c("Save",-1)])]),_:1},8,["loading"])]),default:s(()=>[l(_e,{model:o.value,"label-width":"120px"},{default:s(()=>[l(h,{label:"Class",required:""},{default:s(()=>[l(V,{modelValue:o.value.class_id,"onUpdate:modelValue":t[3]||(t[3]=e=>o.value.class_id=e),filterable:"",class:"w-full"},{default:s(()=>[(d(!0),m(E,null,$(B.value,e=>(d(),b(u,{key:e.id,label:e.name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(h,{label:"Section"},{default:s(()=>[l(V,{modelValue:o.value.section_id,"onUpdate:modelValue":t[4]||(t[4]=e=>o.value.section_id=e),filterable:"",clearable:"",class:"w-full"},{default:s(()=>[(d(!0),m(E,null,$(Y.value,e=>(d(),b(u,{key:e.id,label:e.name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(h,{label:"Subject",required:""},{default:s(()=>[l(V,{modelValue:o.value.subject_id,"onUpdate:modelValue":t[5]||(t[5]=e=>o.value.subject_id=e),filterable:"",class:"w-full"},{default:s(()=>[(d(!0),m(E,null,$(T.value,e=>(d(),b(u,{key:e.id,label:e.name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(h,{label:"Date",required:""},{default:s(()=>[l(ce,{modelValue:o.value.exam_date,"onUpdate:modelValue":t[6]||(t[6]=e=>o.value.exam_date=e),type:"date",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",class:"w-full"},null,8,["modelValue"])]),_:1}),l(h,{label:"Start Time",required:""},{default:s(()=>[l(L,{modelValue:o.value.start_time,"onUpdate:modelValue":t[7]||(t[7]=e=>o.value.start_time=e),format:"HH:mm","value-format":"HH:mm",class:"w-full"},null,8,["modelValue"])]),_:1}),l(h,{label:"End Time",required:""},{default:s(()=>[l(L,{modelValue:o.value.end_time,"onUpdate:modelValue":t[8]||(t[8]=e=>o.value.end_time=e),format:"HH:mm","value-format":"HH:mm",class:"w-full"},null,8,["modelValue"])]),_:1}),l(h,{label:"Room"},{default:s(()=>[l(me,{modelValue:o.value.room_name,"onUpdate:modelValue":t[9]||(t[9]=e=>o.value.room_name=e),placeholder:"Room name or number"},null,8,["modelValue"])]),_:1}),l(h,{label:"Paper"},{default:s(()=>[l(V,{modelValue:o.value.paper_id,"onUpdate:modelValue":t[10]||(t[10]=e=>o.value.paper_id=e),filterable:"",clearable:"",class:"w-full"},{default:s(()=>[(d(!0),m(E,null,$(z.value,e=>(d(),b(u,{key:e.id,label:e.title,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),l(I,{modelValue:F.value,"onUpdate:modelValue":t[14]||(t[14]=e=>F.value=e),title:"Datesheet Conflicts",width:"800px"},{footer:s(()=>[l(j,{onClick:t[13]||(t[13]=e=>F.value=!1)},{default:s(()=>[...t[23]||(t[23]=[c("Close",-1)])]),_:1})]),default:s(()=>[U.value.length>0?(d(),m("div",Pe,[(d(!0),m(E,null,$(U.value,(e,f)=>(d(),m("div",{key:f,class:"p-4 bg-red-50 dark:bg-red-900/20 rounded-lg border border-red-200 dark:border-red-800"},[r("p",qe,_(e.reason),1),r("div",Be,[r("p",null,[t[20]||(t[20]=r("strong",null,"Entry A:",-1)),c(" "+_(e.entry_a),1)]),r("p",null,[t[21]||(t[21]=r("strong",null,"Entry B:",-1)),c(" "+_(e.entry_b),1)]),e.suggestion?(d(),m("p",Te,[t[22]||(t[22]=r("strong",null,"Suggestion:",-1)),c(" "+_(e.suggestion),1)])):k("",!0)])]))),128))])):(d(),b(Q,{key:1,title:"No conflicts",description:"All entries are conflict-free",icon:x(K),"icon-color":"green"},null,8,["icon"]))]),_:1},8,["modelValue"])]),_:1})}}};export{Ie as default};
